# –ü–æ–¥–∑–∞–¥–∞—á–∞: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ GPU Instancing

## üìå –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
*   `src/renderer/index.ts` (—Å–æ–∑–¥–∞–Ω–∏–µ instance buffer, –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä-–ø–∞—Å—Å–∞)
*   `src/renderer/shaders/` (–Ω–æ–≤—ã–π —à–µ–π–¥–µ—Ä `mesh_instanced.wgsl` –∏–ª–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö)
*   `src/renderer/pipelines.ts` (–Ω–æ–≤—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä `instancedMeshPipeline`)
*   `src/core/InstancedMesh.ts` (–Ω–æ–≤—ã–π –∫–ª–∞—Å—Å)

## üõ† –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∫–æ–ø–∏–π –æ–¥–Ω–æ–π –≥–µ–æ–º–µ—Ç—Ä–∏–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è–º–∏/—Ü–≤–µ—Ç–∞–º–∏ –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏.

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å `InstancedMesh`
1.  –ù–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç `Mesh` (–∏–ª–∏ `Object3D`).
2.  –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞:
    *   `instanceCount: number`
    *   `instanceMatrix: Matrix4[]` (–º–∞—Å—Å–∏–≤ –º–∞—Ç—Ä–∏—Ü –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞)
    *   `instanceColor: Vector4[]` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–∞—Å—Å–∏–≤ —Ü–≤–µ—Ç–æ–≤)
3.  –ú–µ—Ç–æ–¥ `setMatrixAt(index: number, matrix: Matrix4)` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ç—Ä–∏—Ü—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞.

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å instance buffer
1.  –í —Ä–µ–Ω–¥–µ—Ä–µ—Ä–µ, –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ `InstancedMesh`, —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å `GPUBuffer` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤.
2.  –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞ ‚Äî –º–∞—Ç—Ä–∏—Ü–∞ 4x4 (16 float) –∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ü–≤–µ—Ç (4 float). –í—Å–µ–≥–æ 20 float –Ω–∞ –∏–Ω—Å—Ç–∞–Ω—Å.
3.  –ë—É—Ñ–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å usage: `GPUBufferUsage.VERTEX | GPUBufferUsage.COPY_DST`.

### –®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å —à–µ–π–¥–µ—Ä –∏ –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è –∏–Ω—Å—Ç–∞–Ω—Å–∏–Ω–≥–∞
1.  **–®–µ–π–¥–µ—Ä (`mesh_instanced.wgsl`):**
    *   –í–µ—Ä—à–∏–Ω–Ω—ã–π —à–µ–π–¥–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥–≤–∞ –Ω–∞–±–æ—Ä–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤: per-vertex (–ø–æ–∑–∏—Ü–∏—è, –Ω–æ—Ä–º–∞–ª—å) –∏ per-instance (–º–∞—Ç—Ä–∏—Ü–∞, —Ü–≤–µ—Ç).
    *   Per-instance –∞—Ç—Ä–∏–±—É—Ç—ã –æ–±—ä—è–≤–ª—è—é—Ç—Å—è —Å `@location` –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤–µ—Ä—à–∏–Ω—ã.
2.  **–ö–æ–Ω–≤–µ–π–µ—Ä (`instancedMeshPipeline`):**
    *   –í `vertex.buffers` –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Ç–æ—Ä–æ–π –±—É—Ñ–µ—Ä —Å `stepMode: 'instance'`.
    *   –û–ø–∏—Å–∞—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –º–∞—Ç—Ä–∏—Ü—ã (4 —Å–ª–æ—Ç–∞ `vec4<f32>`) –∏ —Ü–≤–µ—Ç–∞ (1 —Å–ª–æ—Ç `vec4<f32>`).

### –®–∞–≥ 4: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Ü–∏–∫–ª —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
1.  –í `collectSceneObjects` —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å `InstancedMesh` –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø.
2.  –í –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (`render`):
    *   –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ `InstancedMesh` –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ instance buffer –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ `instanceMatrix`/`instanceColor`.
    *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å vertex buffers: —Å–ª–æ—Ç 0 ‚Äî –≥–µ–æ–º–µ—Ç—Ä–∏—è, —Å–ª–æ—Ç 1 ‚Äî –¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤.
    *   –í—ã–∑–≤–∞—Ç—å `drawIndexed` –∏–ª–∏ `draw` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `instanceCount`.

### –®–∞–≥ 5: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
1.  –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å instance buffers, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Ö –∑–∞–Ω–æ–≤–æ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤.
2.  –û–±—ä–µ–¥–∏–Ω—è—Ç—å –≤ –æ–¥–∏–Ω draw call –Ω–µ—Å–∫–æ–ª—å–∫–æ `InstancedMesh`, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –æ–¥–Ω—É –≥–µ–æ–º–µ—Ç—Ä–∏—é, –Ω–æ —Ä–∞–∑–Ω—ã–µ instance –¥–∞–Ω–Ω—ã–µ (–±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è).

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
*   –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç—ã—Å—è—á–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç—Ä–∞–≤—É, –¥–µ—Ä–µ–≤—å—è, —á–∞—Å—Ç–∏—Ü—ã) —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ–º –Ω–∞ CPU.
*   –í –∫–æ–Ω—Å–æ–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ draw calls –¥–ª—è —Ç–∞–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ–∫—Ä–∞—â–∞–µ—Ç—Å—è —Å —Ç—ã—Å—è—á –¥–æ –µ–¥–∏–Ω–∏—Ü.
*   –°–∏–ª—å–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç FPS –≤ —Å—Ü–µ–Ω–∞—Ö, –Ω–∞—Å—ã—â–µ–Ω–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º–∏—Å—è –æ–±—ä–µ–∫—Ç–∞–º–∏.
*   –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π –∏ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞.